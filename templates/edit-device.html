<!DOCTYPE html>

<html>

<head>
    <title> Edit Device </title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{url_for('static', filename='style/edit-device.css')}}">
</head>

<body>
    <p style="display: none;" id="p_device_id" >{{device[0][8]}}</p>
    <p style="display: none;" id="p_parameter_id" >{{device[0][9]}}</p>
    <nav class="navbar navbar-expand-lg navbar-light">
        <button class="button btn btn-light" type="button" onclick="redirectToPage('/manage-devices')">Cancel</button>
        <div class="navbar-nav ml-auto">
            <button class="btn btn-light" type="button" onclick="send_form()">Confirm</button>
        </div>
    </nav>


    <div class="edit-form">
        <div class="device-form">
            <h1>Edit Device</h1>
            <p>Please fill in this form to edit a device.</p>
            <hr>
            <div class="input-container">
                <label for="name">Name</label>
                <input type="text" id="name" name="name" value={{device[0][0]}} required>
            </div>
            <div class="input-container">
                <label for="description">Description</label>
                <input type="text" id="description" name="description" value={{device[0][1]}} required>
            </div>
            <div class="heading">
                <h3>Parameters</h3>
            </div>
            <div class="param-container">
                <div class="parameter">
                    <label for="param-name">Name<input type="text" id="param-name" name="param-name" value={{device[0][2]}}></label>
                    <label for="min-value">Min value<input type="number" id="min-value" name="min-value" value={{device[0][4]}}></label>
                    <label for="max-value">Max value<input type="number" id="max-value" name="max-value" value={{device[0][3]}}></label>
                </div>
                <div class="kpi">
                    <label for="kpi">KPI<input type="button" id="kpi" name="kpi", value="{{kpi[0]}}"></label>
                    <label for="ok-if">OK if<input type="button" id="ok-if" name="ok-if", value="{{kpi[1]}}""></label>
                    <label for="treshold">Treshold<input type="number" id="treshold" name="treshold" value={{device[0][7]}}></label>
                </div>
            </div>  
        </div>



    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        function redirectToPage(url) {
            window.location.href = url;
        }
    </script>
    <script>
        let in_name = document.getElementById("name");
        let in_description = document.getElementById("description");
        let in_param_name = document.getElementById("param-name");
        let in_min_value = document.getElementById("min-value");
        let in_max_value = document.getElementById("max-value");
        let in_kpi = document.getElementById("kpi");
        let in_ok_if = document.getElementById("ok-if");
        let in_treshold = document.getElementById("treshold");

        let dev_id = document.getElementById("p_device_id");
        let param_id = document.getElementById("p_parameter_id");

        async function send_form() {
            if (in_name.value == "" || in_description.value == "") {
                alert("One of the device fields is missing.");
                return;
            }

            if (in_param_name.value == "" || in_min_value.value == "" || in_max_value.value == "" || in_treshold.value == "") {
                alert("One of the parameter fields is missing or wrong.");
                return;
            }

            try {
                const response = await fetch("{{url_for('api_edit_device')}}", {
                    method: "POST",
                    headers: {
                    "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        name: in_name.value,
                        description: in_description.value,
                        param_name: in_param_name.value,
                        min_value: in_min_value.value,
                        max_value: in_max_value.value,
                        kpi: in_kpi.value,
                        ok_if: in_ok_if.value,
                        treshold: in_treshold.value,
                        device_id: parseInt(dev_id.innerHTML),
                        param_id: parseInt(param_id.innerHTML)
                    }),
                });
                
                const result = await response.json();
                if (result.error == false) {
                    window.location.href = "/manage-devices";
                } else {
                    alert("Error: "+ result.message);
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error (in console)");
            }
        }
    </script>
</body>
</html>

<script>
    const kpi_button = document.querySelector("#kpi");
    const ok_if_button = document.querySelector("#ok-if");
    kpi_button.addEventListener("click", updateButton);
    ok_if_button.addEventListener("click", updateButton_ok);

    function updateButton_ok(event) {
    // Access the button that triggered the click event
    const clickedButton = event.target;

    if (clickedButton.value === "Higher") {
        clickedButton.value = "Lower";
    } else {
        clickedButton.value = "Higher";
    }
}

function updateButton(event) {
    // Access the button that triggered the click event
    const clickedButton = event.target;

    if (clickedButton.value === "KPI ON") {
        clickedButton.value = "KPI OFF";
    } else {
        clickedButton.value = "KPI ON";
    }
}


function removeParameter(event){
    const clickedButton = event.target;
    const param_container = clickedButton.parentNode.parentNode.parentNode;
    param_container.parentNode.removeChild(param_container);

}

    function addParameter() {
    // Create a new parameter container div
    var newParamContainerDiv = document.createElement('div');
    newParamContainerDiv.className = 'param-container';

    // Create parameter div
    var parameterDiv = document.createElement('div');
    parameterDiv.className = 'parameter';

    var nameLabel = createInputLabel('param-name', 'Name', 'text');
    var minValueLabel = createInputLabel('min-value', 'Min value','number');
    var maxValueLabel = createInputLabel('max-value', 'Max value','number');

    parameterDiv.appendChild(nameLabel);
    parameterDiv.appendChild(minValueLabel);
    parameterDiv.appendChild(maxValueLabel);

    // Create KPI div
    var kpiDiv = document.createElement('div');
    kpiDiv.className = 'kpi';

    var removeParamButton = createInputLabel('remove-param', 'Remove parameter','button','remove-param');
    var kpiLabel = createInputLabel('kpi', 'KPI','button','kpi');
    var okIfLabel = createInputLabel('ok-if', 'OK if','button','ok-if');
    var tresholdLabel = createInputLabel('treshold', 'Treshold','number');

    kpiDiv.appendChild(removeParamButton);
    kpiDiv.appendChild(kpiLabel);
    kpiDiv.appendChild(okIfLabel);
    kpiDiv.appendChild(tresholdLabel);

    // Append parameter and KPI divs to the new parameter container div
    newParamContainerDiv.appendChild(parameterDiv);
    newParamContainerDiv.appendChild(kpiDiv);

    // Create "Add parameter" button div
    var addParamDiv = document.createElement('div');
    addParamDiv.className = 'add-param';

    var addParamButton = createInputButton('add-param', 'Add parameter');
    addParamButton.onclick = addParameter; // Assign the same function to the new button
    
    //addParamDiv.appendChild(addParamButton);
    newParamContainerDiv.appendChild(addParamDiv);

    // Append the new parameter container div to the body or any other desired parent element
    var form = document.querySelector('.device-form'); // Adjust the selector if needed
    var lastParamContainer = form.querySelector('.param-container:last-child');

    if (lastParamContainer) {
        // If there's an existing .param-container, insert the new one after it
        form.insertBefore(newParamContainerDiv, lastParamContainer.nextSibling);
    } else {
        // If no existing .param-container, just append it to the form
        form.appendChild(newParamContainerDiv);
    }

}

// Helper function to create label elements
function createInputLabel(id, labelText, type,value) {
    var label = document.createElement('label');
    label.for = id;
    label.textContent = labelText;

    var input = document.createElement('input');
    if(type == 'number') {
        input.type = 'number';
    }
    else if(type == 'text') {
        input.type = 'text';
    }
    else if(type == 'button') {
        input.type = 'button';
        if (value === 'kpi') {
            input.value = 'KPI ON';
            input.onclick = updateButton;
        } else if (value === 'ok-if') {
            input.value = 'Higher';
            input.onclick = updateButton_ok;
        }
        else if (value === 'remove-param') {
            input.value = 'Remove parameter';
            input.onclick = removeParameter;
        }
    }
    
    input.id = id;
    input.name = id;

    label.appendChild(input);

    return label;
}

// Helper function to create input button elements
function createInputButton(id, value) {
    var button = document.createElement('input');
    button.type = 'button';
    button.id = id;
    button.name = id;
    button.value = value;

    return button;
}



</script>